# 项目架构文档

## 概述

本项目是一个基于 PyQt5 的 EAN-13 条形码生成器，采用模块化设计，便于维护和扩展。

## 核心模块

### 1. Encoder 模块

EAN-13 编码器核心模块，负责条形码的编码逻辑。

#### 文件结构
```
Encoder/
├── __init__.py      # 主编码器类 EAN13Encoder
├── encoding.py      # 编码表和辅助函数
└── renderer.py      # 条形码渲染器
```

#### EAN13Encoder 类

**职责**：
- 验证输入码（12或13位数字）
- 计算校验位（Modulo-10算法）
- 生成左侧和右侧编码序列
- 输出条形码图像

**主要方法**：
```python
EAN13Encoder(code)
    - 输入：12或13位数字字符串
    - 输出：完整的13位EAN码

encode()
    - 生成左右两侧的条形码编码

calculate_check_digit()
    - 计算校验位

get_imagedata(bar_width, fontSize, spacing)
    - 获取条形码图像数据

save(filename, bar_width, fontSize, spacing)
    - 保存条形码为图像文件
```

#### 编码原理

1. **奇偶校验表 (parity_table)**
   - 根据首位数字确定后续6位的奇偶编码模式

2. **编码表 (encoding_table)**
   - 每个数字对应3种编码：
     - 左侧奇偶编码
     - 左侧偶偶编码
     - 右侧编码

3. **保护条 (GUARDS)**
   - 起始保护：101
   - 中间保护：01010
   - 结束保护：101

### 2. GUI 模块

#### BarcodeItem.py

**BarcodeItem 类** - 单个条形码条目组件

**功能**：
- 用户输入界面（款号、数量、颜色）
- 实时条形码预览
- 选中状态管理
- 图像缓存

**UI布局**：
```
┌────────────────────────────────────┐
│ 款号: [____________] 数量: [__]    │
│ 颜色: [____________]               │
│                                    │
│     [条形码预览区域]               │
│                                    │
│     6901234567890                  │
└────────────────────────────────────┘
```

**主要方法**：
```python
generate_barcode()
    - 生成条形码图像

update_preview()
    - 更新预览图像

set_selected(selected)
    - 设置选中状态
```

#### main.py

**BarcodeGenerator 类** - 主窗口

**功能**：
- 管理多个条形码条目
- 批量操作（添加、删除、清空）
- PDF 导出
- 启动画面

**UI结构**：
```
┌──────────────────────────────────────┐
│         条形码生成器                   │
├──────────────────────────────────────┤
│  ┌────────────────────────────────┐  │
│  │   滚动区域（条目列表）          │  │
│  │   ┌──────────────────────┐    │  │
│  │   │ 条目 1               │    │  │
│  │   └──────────────────────┘    │  │
│  │   ┌──────────────────────┐    │  │
│  │   │ 条目 2               │    │  │
│  │   └──────────────────────┘    │  │
│  │                                │  │
│  └────────────────────────────────┘  │
│                                      │
│  [添加条目] [删除选中] [一键清空]     │
│  [导出PDF] [打开送货单]              │
└──────────────────────────────────────┘
```

**PDF导出流程**：
```
1. 收集所有条形码数据
2. 计算页面布局（7列×16行）
3. 使用 reportlab 生成 PDF
4. 每个条形码包含：
   - 条形码图像
   - 款号
   - 数量
   - 颜色信息
```

#### Shipment.py

**SingleDeliveryNote 类** - 送货单组件

**功能**：
- 创建和管理送货单
- 表格数据编辑
- 自动计算总金额
- 折叠/展开视图
- 打印功能

**UI结构**：
```
┌──────────────────────────────────────┐
│ 送货单 #1  [折叠/展开] [删除此单]    │
├──────────────────────────────────────┤
│           送 货 单                    │
│                                      │
│ 客户: [____________]  日期: [____]   │
│ 地址: [____________]                 │
│                                      │
│ ┌────────────────────────────────┐  │
│ │ 商品 │ 数量 │ 单价 │ 金额      │  │
│ ├──────┼──────┼──────┼──────────┤  │
│ │      │      │      │          │  │
│ └──────┴──────┴──────┴──────────┘  │
│                                      │
│ 总金额: ¥________                   │
└──────────────────────────────────────┘
```

## 数据流

### 条形码生成流程

```
用户输入款号
    ↓
验证输入（12或13位数字）
    ↓
EAN13Encoder.encode()
    ↓
计算校验位
    ↓
根据奇偶表确定编码模式
    ↓
生成左右两侧编码
    ↓
EAN13Renderer 渲染图像
    ↓
显示预览
```

### PDF导出流程

```
点击"导出PDF"
    ↓
收集所有条目数据
    ↓
计算布局参数
    ↓
创建 reportlab.canvas
    ↓
循环渲染条形码
    ↓
保存PDF文件
```

## 配置参数

### 条形码尺寸 (main.py)

```python
barcode_width = 90      # 条形码宽度（点）
barcode_height = 45     # 条形码高度（点）
barcodes_per_row = 7    # 每行条形码数量
max_items_per_page = 112  # 每页最大条目数
margin_x = 10           # 左右边距
margin_y = 32           # 上下边距
```

### 条形码样式 (BarcodeItem.py)

```python
calculate_barcode_width(style_code)
    - picWidth: 条形码宽度（1-4）
    - frontSize: 字体大小（22.5-35）
    - numberFontSize: 数字字体大小（20-40）
    - spacing: 间距（1.0-1.2）
```

## 扩展指南

### 添加新的条形码格式

1. 在 `Encoder/` 中创建新的编码器类
2. 实现标准的编码接口
3. 在 `BarcodeItem.py` 中添加格式选择
4. 更新 UI 以支持新格式

### 自定义PDF布局

修改 `main.py` 中的布局参数：
```python
barcodes_per_row = 5    # 改为每行5个
barcode_width = 100     # 增大宽度
```

### 添加数据库支持

1. 创建 `database.py` 模块
2. 使用 SQLite 或其他数据库
3. 添加保存/加载功能
4. 在主窗口添加数据库菜单

## 性能优化

1. **图像缓存**：条形码图像生成后缓存，避免重复生成
2. **延迟渲染**：只在需要时渲染条形码
3. **批量操作**：PDF导出时批量处理，减少I/O操作

## 安全考虑

1. **输入验证**：所有输入都需要验证格式
2. **文件路径**：使用文件对话框，避免路径注入
3. **错误处理**：完善的异常处理机制
